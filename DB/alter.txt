CREATE DATABASE postinsurance DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;

exi

-- 20150506
alter table t_policy add column operate_id bigint;
alter table t_policy add column operate_name date;
alter table t_policy add column operate_time varchar(32);

--20150530
alter table t_bank_code add column bank_name varchar(128);
alter table t_prd add column multiple int;

--20150604
drop table if exists t_policy;

/*==============================================================*/
/* Table: t_policy                                              */
/*==============================================================*/
create table t_policy
(
   id                   bigint not null auto_increment,
   organ_code           varchar(20),
   organ_name           varchar(60),
   policy_no            varchar(12),
   form_no              varchar(25),
   holder               varchar(256),
   insured              varchar(256),
   prod_code            varchar(8),
   prod_name            varchar(128),
   policy_fee           varchar(256),
   insured_amount       varchar(256),
   fee_frequency        varchar(10),
   perm                 int,
   plicy_valid_date     date,
   policy_date          date,
   status               int,
   bank_id              bigint,
   bank_code            varchar(12),
   bank_name            varchar(128),
   sales_name           varchar(256),
   sales_id             varchar(256),
   copies               varchar(256),
   renewal_sucess_flag  int,
   reset_valid_flag     int,
   operate_id           bigint,
   operate_time         date,
   operate_name         varchar(32),
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_policy add column
organ_code           varchar(20),
add column   organ_name           varchar(60),
add column   policy_no            varchar(12),
add column   form_no              varchar(25),
add column   holder               varchar(256),
add column   insured              varchar(256),
add column   prod_code            varchar(8),
add column   prod_name            varchar(128),
add column   policy_fee           varchar(256),
add column   insured_amount       varchar(256),
add column   fee_frequency        varchar(10),
add column   perm                 int,
add column   plicy_valid_date     date,
add column   policy_date          date,
add column   status               int,
add column   bank_id              bigint,
add column   bank_code            varchar(12),
add column   bank_name            varchar(128),
add column   sales_name           varchar(256),
add column   sales_id             varchar(256),
add column   copies               varchar(256),
add column   renewal_sucess_flag  int,
add column   reset_valid_flag     int,
add column   operate_id           bigint,
add column   operate_time         date,
add column   operate_name         varchar(32);

drop table if exists t_policy_dtl;

/*==============================================================*/
/* Table: t_policy_dtl                                          */
/*==============================================================*/
create table t_policy_dtl
(
   id                   bigint not null auto_increment,
   organ_code           varchar(60),
   policy_no            varchar(12),
   holder               varchar(256),
   holder_sexy          int,
   insured              varchar(256),
   prod_name            varchar(128),
   insured_amount       varchar(256),
   policy_fee           varchar(256),
   sales_name           varchar(256),
   policy_date          date,
   holder_phone         varchar(256),
   holder_mobile        varchar(256),
   holder_addr          varchar(512),
   holder_postcode      varchar(6),
   holder_card_type     int,
   holder_card_num      varchar(256),
   operate_id           bigint,
   operate_time         date,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_issue add column
   organ_code           varchar(18),
add column      call_man             varchar(8),
add column      issue_no             varchar(12),
add column      policy_no            varchar(18),
add column      issue_desc           varchar(6),
add column      issue_type           varchar(10),
add column      issue_content        varchar(256),
add column      result       varchar(256),
add column      ready_date           timestamp default current_timestamp,
add column      finish_date          datetime,
add column      bank_code            varchar(20),
add column      bank_name            varchar(256),
add column      should_date          date,
add column      call_date            date,
add column      issue_date           date,
add column      reset_num            int,
add column      recall_flag          varchar(2),
add column      issue_time           date,
add column      status               varchar(10),
add column      deal_man             varchar(32),
add column      deal_time            date,
add column      reopen_reason        varchar(256),
add column      reopen_id            bigint,
add column      reopen_date          date,
add column      operate_id          bigint,
add column      operate_time          timestamp default current_timestamp;


alter table t_policy 
add column   customer_manager_code         varchar(25),
add column   customer_manager              varchar(16);


INSERT INTO t_renewed_list(policy_no, fee_status, fee_fail_reason, prd_name) 
VALUES
('86440100003942', '你好', 'Eliot', '中邮附加重大疾病保险'),
('86440100003942', 'hello', 'Jhon', '中邮年年好B款年金保险（分红型）'), 
('86440100005030', '嘻嘻', 'Jim', '中邮年年好百倍保两全保险') 
ON DUPLICATE KEY UPDATE 
policy_no=VALUES(policy_no), prd_name=VALUES(prd_name), 
fee_status=VALUES(fee_status), fee_fail_reason=VALUES(fee_fail_reason);

alter table t_renewed_list
add column fix_status           varchar(12),
add column    fix_desc             varchar(256),
add column    deal_man             varchar(12),
add column    deal_time            date;

alter table t_call_fail_list add column organ_name varchar(20);
alter table t_issue add column organ_name varchar(20);
alter table t_call_fail_list add column hq_deal_num int;
alter table t_call_fail_list add column prov_deal_num int;
alter table t_issue add column holder_mobile varchar(256);
alter table t_issue add column holder_phone varchar(256);
alter table t_call_fail_list add column holder_phone varchar(256);
alter table t_call_fail_list add column holder_mobile varchar(256);

/* 2015-08-06*/
alter table `t_call_fail_list` add column reset_phone VARCHAR(256);
--------------- SQL ---------------

ALTER TABLE `t_call_fail_list` ADD COLUMN `org_deal_flag` TINYINT(4) DEFAULT 0;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_flag` TINYINT(4) DEFAULT 0;
ALTER TABLE `t_call_fail_list` ADD COLUMN `prov_deal_flag` TINYINT(4) DEFAULT 0;

===============20150810
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_date6` date DEFAULT NULL AFTER `hq_deal_rst5`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_rst6` VARCHAR(120) DEFAULT NULL AFTER `hq_deal_date6`;
--------------- SQL ---------------

ALTER TABLE `t_call_fail_list` ADD COLUMN `has_letter` VARCHAR(32) DEFAULT NULL;

--------------- SQL ---------------

ALTER TABLE `t_call_fail_list` ADD COLUMN `letter_date` DATE DEFAULT NULL;

--------------- SQL ---------------

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no`);

======20150817
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type` varchar(20) DEFAULT NULL AFTER `hq_issue_type`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man` varchar(20) DEFAULT NULL AFTER `hq_deal_type`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type2` varchar(20) DEFAULT NULL AFTER `hq_deal_date2`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man2` varchar(20) DEFAULT NULL AFTER `hq_deal_type2`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type3` varchar(20) DEFAULT NULL AFTER `hq_deal_date3`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man3` varchar(20) DEFAULT NULL AFTER `hq_deal_type3`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type4` varchar(20) DEFAULT NULL AFTER `hq_deal_date4`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man4` varchar(20) DEFAULT NULL AFTER `hq_deal_type4`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type5` varchar(20) DEFAULT NULL AFTER `hq_deal_date5`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man5` varchar(20) DEFAULT NULL AFTER `hq_deal_type5`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type6` varchar(20) DEFAULT NULL AFTER `hq_deal_date6`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man6` varchar(20) DEFAULT NULL AFTER `hq_deal_type6`;

alter table t_call_deal_type add column flag int default 0;

====20050825
alter table t_renewed_list add column hq_deal_man varchar(32) AFTER `hq_deal_date`;
alter table t_renewed_list add column prov_deal_man varchar(32);
alter table t_renewed_list add column deal_type varchar(32) AFTER `fix_desc`;
alter table t_renewal_type add column flag int default 0;
ALTER TABLE `t_call_fail_list` ADD COLUMN `prov_deal_man` varchar(20) DEFAULT NULL AFTER `prov_issue_type`;

use picodb;

drop table if exists t_under_write;

/*==============================================================*/
/* Table: t_under_write                                         */
/*==============================================================*/
create table t_under_write
(
   id                   bigint not null auto_increment,
   policy_no            varchar(18),
   form_no              varchar(25),
   organ_id             bigint,
   product_id           bigint,
   holder               varchar(32),
   insured              varchar(32),
   underwrite_reason    varchar(64),
   ybt_date             date,
   sys_date             datetime,
   check_date           datetime,
   issue_flag           tinyint,
   error_desc           varchar(256),
   deal_man             varchar(12),
   underwrite_date      datetime,
   is_letter            boolean,
   sign_date            datetime,
   prov_receive_date    date,
   prov_send_date       date,
   prov_ems_no          varchar(32),
   city_receive_date    date,
   city_send_date       date,
   city_ems_no          varchar(32),
   area_receive_date    date,
   area_send_date       date,
   area_ems_no          varchar(32),
   net_receive_date     date,
   client_receive_date  date,
   sign_input_date      date,
   remark               varchar(250),
   primary key (id),
   unique key ak_key_2 (policy_no)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_under_write add constraint fk_uw_prd foreign key (product_id)
      references t_prd (id);

alter table t_under_write add constraint fk_uw_org foreign key (organ_id)
      references t_organization (id);

alter table t_under_write add column relation varchar(16) after insured;
alter table t_under_write add column policy_fee double after relation;

create table t_pay_fail_list
(
   id                   bigint not null auto_increment,
   account_name         varchar(32),
   account              varchar(256),
   money                varchar(12),
   fail_desc            varchar(32),
   back_date            date,
   fee_type             varchar(16),
   rel_no               varchar(32),
   org_name             varchar(64),
   pay_type             int,
   status               varchar(12),
   operate_id           bigint,
   operate_time         datetime default current_timestamp,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

create table t_check_fix_type
(
   id                   bigint not null auto_increment,
   type_name            varchar(32),
   type_desc            varchar(255),
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_check_write add column fix_type varchar(64) after fix_status;
alter table t_check_record add column fix_type varchar(64) after fix_status;

--------------- SQL ---------------

ALTER TABLE `t_pay_fail_list` MODIFY COLUMN `rel_no` VARCHAR(32) COLLATE utf8_general_ci NOT NULL UNIQUE;

create table t_notice
(
   id                   bigint not null auto_increment,
   sender               bigint,
   send_date            datetime default current_timestamp,
   receiver             bigint,
   receive_org          bigint,
   receive_role         bigint,
   invalid_date         date,
   notice_title         varchar(64),
   notice_content       text,
   primary key (id)
);

create table t_notice_att
(
   id                   bigint not null,
   notice_id            bigint,
   attr_link            varchar(128),
   primary key (id)
);
alter table t_notice_att add constraint fk_notice_attr foreign key (notice_id)
      references t_notice (id) on delete restrict on update restrict;


ALTER TABLE `t_under_write` ADD COLUMN `has_record` TINYINT(1) DEFAULT 1 AFTER `error_desc`;

ALTER TABLE `t_under_write` ADD COLUMN `record_desc` VARCHAR(254) DEFAULT 1 AFTER `has_record`;

ALTER TABLE `t_under_write` ADD COLUMN `status` VARCHAR(16) DEFAULT 1 AFTER `deal_man`;


create table t_offsite_conservation
(
   id                   bigint not null auto_increment,
   org_code             varchar(16),
   transactor           varchar(16),
   deal_date            date,
   policy_no            varchar(18),
   orgin_prov           varchar(12),
   client               varchar(12),
   conservation_type    varchar(12),
   linker               varchar(12),
   prov_deal_date       date,
   express_bill_no      varchar(16),
   mail_addr            varchar(128),
   remark               varchar(256),
   operator_id          bigint,
   operate_time         datetime,
   primary key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

create table t_prov_org_code
(
   id                   bigint not null auto_increment,
   org_code             varchar(8),
   org_name             varchar(12),
   primary key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

create table t_conservation_type
(
   id                   bigint not null auto_increment,
   cs_type              varchar(4),
   cs_name              varchar(16),
   primary key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

ALTER TABLE `t_conservation_dtl` MODIFY COLUMN `type` VARCHAR(8) DEFAULT NULL;

update t_conservation_dtl set type=info;
update t_conservation_dtl set info=cs_rst;
update t_conservation_dtl set cs_rst=null;

ALTER TABLE `t_call_fail_list` ADD COLUMN `addr` VARCHAR(256) DEFAULT NULL AFTER `result`;
ALTER TABLE `t_issue` ADD COLUMN `addr` VARCHAR(256) DEFAULT NULL AFTER `issue_content`;

ALTER TABLE `t_call_fail_list` ADD COLUMN `id_card` VARCHAR(256) DEFAULT NULL AFTER `result`;
ALTER TABLE `t_issue` ADD COLUMN `id_card` VARCHAR(256) DEFAULT NULL AFTER `issue_content`;

--------------- SQL ---------------

ALTER TABLE `t_offsite_conservation` ADD COLUMN `status` VARCHAR(12) DEFAULT NULL AFTER `remark`;

--------------- SQL ---------------

ALTER TABLE `t_conservation_dtl` CHANGE COLUMN `type` `conservation_code` VARCHAR(8) COLLATE utf8_general_ci DEFAULT NULL;
--------------- SQL ---------------

ALTER TABLE `t_notice_att` MODIFY COLUMN `id` BIGINT(20) NOT NULL AUTO_INCREMENT;


alter table t_conservation_dtl  add column cs_sys_date date;
alter table t_conservation_dtl  add column cs_fee double;

create table t_cs_reissue
(
   id                   bigint not null,
   cs_id                bigint,
   prov_express_no      varchar(32),
   prov_receive_date    date,
   prov_sent_date       date,
   status               varchar(12),
   city_receive_date    date,
   city_receiver        varchar(16),
   remark               varchar(255),
   primary key (id)
);

alter table t_cs_reissue add constraint fk_reference_28 foreign key (cs_id)
      references t_conservation_dtl (id) on delete restrict on update restrict;


create table t_pay_success_list
(
   id                   bigint not null auto_increment,
   account_name         varchar(32),
   account              varchar(256),
   money                varchar(12),
   fail_desc            varchar(32),
   back_date            date,
   fee_type             varchar(16),
   rel_no               varchar(32),
   org_name             varchar(64),
   pay_type             int,
   status               int,
   operate_id           bigint,
   operate_time         datetime default current_timestamp,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_call_fail_list  add column can_call_again boolean;
alter table t_call_fail_list  add column can_call_again_remark varchar(127);

--------------- SQL ---------------

ALTER TABLE `t_under_write` ADD COLUMN `holder_age` TINYINT(4) DEFAULT NULL AFTER `holder`;
ALTER TABLE `t_log_info` MODIFY COLUMN `message` VARCHAR(1024) COLLATE utf8_general_ci DEFAULT NULL;

ALTER TABLE `t_offsite_conservation` ADD COLUMN `deal_prov` VARCHAR(32) DEFAULT NULL;

--------------- SQL ---------------

ALTER TABLE `t_notice_att` MODIFY COLUMN `id` BIGINT(20) NOT NULL AUTO_INCREMENT;

ALTER TABLE `t_call_fail_list` ADD COLUMN `reset_date` DATE DEFAULT NULL;

--------------- SQL ---------------

ALTER TABLE `t_policy` ADD COLUMN `bill_back_date` DATE DEFAULT NULL AFTER `policy_date`;

ALTER TABLE `t_offsite_conservation` ADD COLUMN `deal_prov` VARCHAR(32) DEFAULT NULL;

-- alter table t_call_fail_list add column door_back_rst varchar(128) default null;

-- alter table t_call_fail_list add column door_date date default null;

-- alter table t_call_fail_list add column door_man varchar(32) default null;

alter table t_call_fail_list add column door_back_date date default null;

alter table t_call_fail_list add column door_stats_date date default null;

alter table t_call_fail_list add column mail_fail_reason varchar(128) default null;

alter table t_call_fail_list add column mail_fail_date date default null;

alter table t_call_fail_list add column mail_success varchar(32) default null;

alter table t_call_fail_list add column mail_back_date date default null;

alter table t_call_fail_list add column client_sign_date date default null;

ALTER TABLE `t_log_info` ADD COLUMN `module` VARCHAR(32) DEFAULT NULL;

ALTER TABLE `t_call_fail_list` MODIFY COLUMN `finish_date` TIMESTAMP NULL;

--------------- SQL ---------------

ALTER TABLE `t_renewed_list` MODIFY COLUMN `policy_no` VARCHAR(18) COLLATE utf8_general_ci NOT NULL UNIQUE;

update t_call_fail_list t1, t_call_fail_list t2
set t1.status=t2.status
where t1.policy_no=t2.policy_no
and t2.status="二访成功"

alter table t_call_fail_list add column client_remark varchar(254) default null;
alter table t_call_fail_list add column hq_deal_type_else varchar(254) default null;

DELETE FROM `t_call_fail_list`
USING `t_call_fail_list`,(
  SELECT DISTINCT max(`id`) AS `id`,`policy_no`
  FROM `t_call_fail_list`
  GROUP BY `policy_no`
  HAVING COUNT(1) > 1
) AS `t2`
WHERE `t_call_fail_list`.`policy_no` = `t2`.`policy_no`
  AND `t_call_fail_list`.`id` <> `t2`.`id`;
  
alter table t_call_fail_list add column phone_num varchar(23) default null;
alter table t_call_fail_list add column phone_start varchar(23) default null;
alter table t_call_fail_list add column phone_end varchar(23) default null;
alter table t_call_fail_list add column phone_time varchar(23) default null;

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no` and b.flag=0);

ALTER TABLE `t_policy` ADD INDEX `idx_policy_formno` (`form_no`);

update t_policy set policy_fee=cast(aes_decrypt(unhex(policy_fee), 'GDPost') as char(100));

update t_policy set holder=cast(aes_decrypt(unhex(holder), 'GDPost') as char(100));

ALTER TABLE `t_policy` MODIFY COLUMN `policy_fee` DOUBLE(15,2) DEFAULT NULL;

ALTER TABLE `t_prd` ADD COLUMN `prd_full_name` VARCHAR(36) DEFAULT NULL AFTER `prd_name`;

ALTER TABLE `t_settlement` ADD COLUMN `policy_no` VARCHAR(21) DEFAULT NULL AFTER `org_id`;

ALTER TABLE `t_settlement` ADD COLUMN `operate_id` BIGINT(20) DEFAULT NULL;

ALTER TABLE `t_settlement` ADD COLUMN `create_time` TIMESTAMP(6) NULL DEFAULT CURRENT_TIMESTAMP(6);

ALTER TABLE `t_settlement_dtl` ADD COLUMN `claims_no` VARCHAR(21) DEFAULT NULL AFTER `id`;


CREATE TABLE t_settlement_dtl (
  id BIGINT(20) NOT NULL AUTO_INCREMENT,
  claims_no VARCHAR(21),
  settlement_id BIGINT(20),
  policy_no VARCHAR(18),
  prod_name VARCHAR(64),
  policy_fee DOUBLE,
  policy_date DATE,
  first_case_time DATE,
  case_man CHAR(10),
  first_file_date DATE,
  first_sign_man VARCHAR(32),
  all_file_date DATE,
  all_sign_man VARCHAR(32),
  check_date DATE,
  checker VARCHAR(32),
  check_done_date DATE,
  check_done_man VARCHAR(32),
  PRIMARY KEY (id),
  KEY fk_reference_33 (settlement_id) USING BTREE,
  CONSTRAINT fk_reference_33 FOREIGN KEY (settlement_id) REFERENCES t_settlement (id)
) ENGINE=InnoDB
AUTO_INCREMENT=1 CHARACTER SET utf8 COLLATE utf8_general_ci;


ALTER TABLE t_invoice_req ADD COLUMN is_elective_bill Boolean DEFAULT FALSE;

ALTER TABLE t_invoice_req ADD COLUMN bill_addr varchar(18) DEFAULT NULL;

drop table t_settlement_dtl;

ALTER TABLE `t_settlement_log` MODIFY COLUMN `id` BIGINT(20) NOT NULL AUTO_INCREMENT;

ALTER TABLE t_settle_task ADD COLUMN settleDtl_id BIGINT(20) NOT NULL;


ALTER TABLE `t_settle_task` ADD COLUMN `prod_name` VARCHAR(32) DEFAULT NULL AFTER `insured`;
ALTER TABLE `t_settle_task` ADD COLUMN `policy_fee` VARCHAR(32) DEFAULT NULL AFTER `prod_name`;
ALTER TABLE `t_settle_task` ADD COLUMN `policy_date` VARCHAR(32) DEFAULT NULL AFTER `policy_fee`;
ALTER TABLE `t_settle_task` ADD COLUMN `case_date` VARCHAR(32) DEFAULT NULL AFTER `policy_date`;
ALTER TABLE `t_settle_task` ADD COLUMN `case_type` VARCHAR(32) DEFAULT NULL AFTER `case_date`;

ALTER TABLE t_call_fail_list MODIFY COLUMN `door_stats_date` VARCHAR(12) DEFAULT NULL;
create table t_policy_reprint_dtl
(
   id                   bigint not null auto_increment,
   print_no             varchar(12),
   status               varchar(6),
   org_code             varchar(8),
   form_no              varchar(15),
   policy_no            varchar(18),
   ems_no               varchar(18),
   print_date           datetime,
   flag                 varchar(1),
   operate_id           bigint,
   operate_time         timestamp DEFAULT CURRENT_TIMESTAMP,
   primary key (id)
);

alter table t_policy add column flag int(1) not null default 0;

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no` and b.flag=0);

alter table t_under_write add column to_net boolean not null default false after prov_send_date;
update t_under_write set status="CloseStatus" where sign_input_date is not null;

drop table if exists t_bank_code;

/*==============================================================*/
/* Table: t_bank_code                                           */
/*==============================================================*/
create table t_bank_code
(
   id                   bigint not null auto_increment,
   ybt_code             varchar(10),
   cpi_code             varchar(18),
   bank_code            varchar(20),
   name                 varchar(60),
   organ_code           varchar(8),
   flag                 tinyint(1),
   status               int default 1,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

drop table if exists t_conservation_req;

/*==============================================================*/
/* Table: t_conservation_req                                    */
/*==============================================================*/
create table t_conservation_req
(
   id                   bigint not null auto_increment,
   form_no              varchar(25),
   policy_no            varchar(18),
   bank_code            varchar(8),
   bank_name            varchar(64),
   req_man              varchar(12),
   req_type_name        varchar(32),
   req_date             date,
   req_phone            varchar(18),
   status               varchar(12) default 'NewStatus',
   operate_id           bigint,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_renewed_list add column prov_activity VARCHAR(64);

drop table if exists t_cs_report;

/*==============================================================*/
/* Table: t_cs_report                                           */
/*==============================================================*/
create table t_cs_report
(
   id                   bigint not null auto_increment,
   cs_no                varchar(17),
   policy_no            varchar(15),
   organ_name           varchar(64),
   net_name             varchar(128),
   cs_channel           varchar(12),
   operate_org          varchar(6),
   holder               varchar(16),
   insured              varchar(16),
   cs_date              date,
   cs_code              varchar(4),
   money                double,
   cs_deal              varchar(12),
   operate_id           bigint,
   operate_time         datetime default current_timestamp,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

/*==========20161210===========*/
alter table t_call_fail_list modify column issue_no VARCHAR(21);
alter table t_call_fail_list modify column status VARCHAR(16) not null default "待处理";
alter table t_call_fail_list modify column issue_type VARCHAR(16);
alter table t_call_fail_list modify column finish_date timestamp default current_timestamp;
alter table t_call_fail_list add column task_type VARCHAR(32);
alter table t_call_fail_list add column issue_org VARCHAR(32);
alter table t_call_fail_list add column client_no VARCHAR(16);
alter table t_call_fail_list add column client_name VARCHAR(16);
alter table t_call_fail_list add column client_sexy VARCHAR(6);
alter table t_call_fail_list add column issue_prov VARCHAR(16);
alter table t_call_fail_list add column issue_city VARCHAR(16);
alter table t_call_fail_list add column issue_area VARCHAR(16);
alter table t_call_fail_list add column deal_dep VARCHAR(64);
alter table t_call_fail_list add column manual_status VARCHAR(32);
alter table t_call_fail_list add column call_type VARCHAR(32);
alter table t_call_fail_list add column bill_back_date date;
alter table t_call_fail_list add column policy_term VARCHAR(6);
alter table t_call_fail_list add column policy_fee_type VARCHAR(6);
alter table t_call_fail_list add column policy_fee_year VARCHAR(6);
alter table t_call_fail_list add column fix_call_rst VARCHAR(32);
alter table t_call_fail_list add column attr_prod VARCHAR(32);
alter table t_call_fail_list add column attr_fee double;
alter table t_call_fail_list add column attr_year VARCHAR(32);
alter table t_call_fail_list add column attr_type VARCHAR(32);
alter table t_call_fail_list add column attr_fee_year VARCHAR(32);

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no` and b.flag=0);
  
alter table t_issue modify column issue_no VARCHAR(21);
alter table t_issue modify column status VARCHAR(16) not null default "待处理";
alter table t_issue modify column issue_type VARCHAR(16);
alter table t_issue modify column finish_date timestamp default current_timestamp;
alter table t_issue add column task_type VARCHAR(32);
alter table t_issue add column issue_org VARCHAR(32);
alter table t_issue add column client_no VARCHAR(16);
alter table t_issue add column client_name VARCHAR(16);
alter table t_issue add column client_sexy VARCHAR(6);
alter table t_issue add column issue_prov VARCHAR(16);
alter table t_issue add column issue_city VARCHAR(16);
alter table t_issue add column issue_area VARCHAR(16);
alter table t_issue add column deal_dep VARCHAR(64);
alter table t_issue add column manual_status VARCHAR(32);
alter table t_issue add column call_type VARCHAR(32);
alter table t_issue add column bill_back_date date;
alter table t_issue add column policy_term VARCHAR(6);
alter table t_issue add column policy_fee_type VARCHAR(6);
alter table t_issue add column policy_fee_year VARCHAR(6);
alter table t_issue add column fix_call_rst VARCHAR(32);
alter table t_issue add column attr_prod VARCHAR(32);
alter table t_issue add column attr_fee double ;
alter table t_issue add column attr_year VARCHAR(6);
alter table t_issue add column attr_type VARCHAR(32);
alter table t_issue add column attr_fee_year VARCHAR(6);


create table t_staff
(
   id                   bigint not null auto_increment,
   name            	    varchar(17),
   id_card   	    	    varchar(64),
   status		     	      varchar(2),
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;


alter table t_policy_reprint_dtl change flag pl_flag varchar(1);
alter table t_bank_code change flag net_flag tinyint(1);
alter table t_call_deal_type change flag type_flag tinyint(1);
alter table t_renewal_type change flag type_flag tinyint(1);
alter table t_invoice_req change flag req_flag varchar(2) DEFAULT NULL COMMENT '首期 续期';
alter table t_policy change flag attached_flag int(1) default 0;
drop table t_call_feedback;
drop table t_convicted_info;
drop table t_call_fail;
drop table t_category_org;
drop table t_remit_money_list;
drop table t_renewal_dtl;
drop table t_renewal_fee_dtl;

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no` and b.attached_flag=0);

ALTER TABLE t_bank_code ADD INDEX idx_bc(`cpi_code`,`net_flag`);
ALTER TABLE t_cs_report ADD INDEX idx_cs_rt(`policy_no`,`cs_date`);
alter table t_policy add index idx_p_date(`policy_date`);
alter table t_policy add index idx_p_bc(`bank_code`);
alter table t_conservation_req add index idx_req_d(`req_date`);
alter table t_conservation_req add index idx_creq_s(`status`);
alter table t_conservation_req add index idx_creq_bc(`bank_code`);
alter table t_conservation_req add index idx_creq_m(`policy_no`,`form_no`,`bank_code`);
alter table t_pay_success_list add index idx_psl_s(`status`);
alter table t_pay_success_list add index idx_psl_bd(`back_date`);
alter table t_pay_fail_list add index idx_psl_s(`status`);
alter table t_pay_fail_list add index idx_psl_bd(`back_date`);
alter table t_call_fail_list add index idx_cfl_oc(`organ_code`);
alter table t_call_fail_list add index idx_cfl_rd(`ready_date`);
alter table t_call_fail_list add index idx_cfl_in(`issue_no`);
alter table t_renewed_list add index idx_rl_in(`fee_status`);
alter table t_renewed_list add index idx_rl_ffr(`fee_fail_reason`);
alter table t_renewed_list add index idx_rl_hit(`hq_issue_type`);
alter table t_renewed_list add index idx_rl_dt(`deal_type`);
alter table t_renewed_list add index idx_rl_fd(`fee_date`);
alter table t_renewed_list add index idx_rl_pa(`prov_activity`);
alter table t_renewed_list add index idx_rl_p(`policy_no`);
alter table t_policy add index idx_p_p(`policy_no`);
alter table t_policy add index idx_p_oc(`organ_code`);
alter table t_policy add index idx_p_op(`organ_code`,`policy_no`);
alter table t_policy add index idx_p_pa(`policy_no`,`attached_flag`);
alter table t_call_fail_list add index idx_cfl_s(`status`);
alter table t_call_fail_list add index idx_cfl_hl(`has_letter`);
alter table t_call_fail_list add index idx_cfl_cca(`can_call_again`);
alter table t_call_fail_list add index idx_cfl_dt(`deal_type`);
alter table t_call_fail_list add index idx_cfl_hdt(`hq_deal_type`);
alter table t_call_fail_list add index idx_cfl_odf(`org_deal_flag`);
alter table t_call_fail_list add index idx_cfl_hdf(`hq_deal_flag`);
alter table t_issue add index idx_i_p(`policy_no`);
alter table t_issue add index idx_i_s(`status`);
alter table t_issue add index idx_i_sd(`should_date`);
alter table t_issue_type add column type_code varchar(12);

CREATE UNIQUE INDEX idx_idcard ON t_staff(id_card); 

alter table t_policy add column staff_flag boolean default false;
alter table t_cs_report add column staff_flag boolean default false;
alter table t_policy add index idx_tpsf(`staff_flag`);
alter table t_policy add column cs_flag tinyint default 0;

alter table t_policy add fulltext index idx_p_pn(`prod_name`);
alter table t_under_write add column plan_date date default NULL;
alter table t_under_write add column plan_flag boolean default false;
create table t_cs_addr
(
   id  bigint not null auto_increment,
   organ_code  varchar(8),
   prov  varchar(12),
   city  varchar(17),
   linker  varchar(12),
   phone  varchar(24),
   addr  varchar(128),
   post_code  varchar(6),
   primary key (id)
)engine=innodb auto_increment=1 default charset=utf8;

alter table t_renewed_list add column fee_match varchar(24);
璋冩暣缁湡鍌敹鍒楄〃涓婚敭鍔犱笂骞村害銆?

delete from t_bank_code where id=1849;
 delete from t_bank_code where id=228;
 delete from t_bank_code where id=223;
 
create table t_mtd_code
(
   id  bigint not null auto_increment,
   prod_code  varchar(8),
   duty_code  varchar(12),
   prod_name varchar(64),
   prod_attr varchar(64),
   perm integer,
   match_code varchar(12),
   primary key (id)
)engine=innodb auto_increment=1 default charset=utf8;

 alter table t_under_write modify underwrite_reason varchar(128);
alter table t_under_write add column prd_name varchar(64);
alter table t_under_write add column insured_age integer;
alter table t_under_write add column perm integer;
alter table t_under_write add column issue integer;
alter table t_under_write add column body_check_date1 date;
alter table t_under_write add column body_check_date2 date;
alter table t_under_write add column hb_end_date date;
alter table t_under_write add column form_write_date date;
alter table t_under_write add column sync boolean default false;

update t_under_write set policy_no='86440100019944' where form_no='281060004357376';
delete yuesu policy_no from t_under_write;
update t_under_write uw, t_policy tp set uw.policy_no=tp.policy_no, uw.holder=tp.holder, uw.insured=tp.insured, uw.sign_date=tp.policy_date, uw.policy_fee=tp.policy_fee, uw.sync=true where uw.form_no=tp.form_no and sync=false;

alter table t_under_write add column net_name varchar(128);

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW v_policy_data
AS
select tp.id,tp.policy_no,tp.form_no,tp.holder, 
cast(aes_decrypt(unhex(tpd.holder_phone), 'GDPost') as char(100)) as holder_phone, 
cast(aes_decrypt(unhex(tpd.holder_mobile), 'GDPost') as char(100)) as holder_mobile, 
tpd.holder_card_type, 
cast(aes_decrypt(unhex(tpd.holder_card_num), 'GDPost') as char(100)) as holder_card_num, 
cast(aes_decrypt(unhex(tpd.insured), 'GDPost') as char(100)) as insured, 
'' as insured_phone,'' as insured_card_num, 
tp.prod_code,tp.prod_name,tp.policy_fee,tp.insured_amount,tp.fee_frequency, 
tp.perm,tp.policy_date,tp.plicy_valid_date,tp.status,tp.bank_code,'银行转账' as fee_type, 
'' as bank_account, tp.cs_flag, case when uw.policy_no is null then 'N' else 'Y' end as uw_flag 
from t_policy tp 
left join t_policy_dtl tpd on tp.policy_no=tpd.policy_no 
left join t_under_write uw on tp.policy_no=uw.policy_no 
where tp.organ_code<>'86440001' and tp.policy_date>='2017-01-01'
order by tp.organ_code, tp.policy_date;

 grant select on postinsurance.v_policy_data to postxxj@'%' identified by 'PostXxj';
  grant select on postinsurance.v_policy_data to postxxj@'localhost' identified by 'PostXxj';
  
  alter table t_policy_dtl add column insured_card_type varchar(64);
  alter table t_policy_dtl add column insured_card_num varchar(256);
  alter table t_policy_dtl add column insured_card_valid varchar(14);
  alter table t_policy_dtl add column bank_account varchar(256);

alter table t_renewed_list add column give_fee varchar(6);
alter table t_renewed_list add column give_flag varchar(6);
alter table t_renewed_list add column give_rst varchar(6);

create table t_renewed_fee_rst
(
   id  bigint not null auto_increment,
   policy_no  varchar(15),
   prod_code  varchar(6),
   holder  varchar(12),
   req_date date,
   req_fee double,
   rst_fee double,
   rst_date date,
   fee_channel varchar(12),
   fee_type varchar(6),
   policy_flag varchar(12),
   operate_id bigint,
   primary key (id)
)engine=innodb auto_increment=1 default charset=utf8;

alter table t_organization add column short_name varchar(64);
alter table t_policy add column cs_date date;

create table t_doc_not_scan_dtl
(
   id	bigint not null auto_increment,
   organ_name		varchar(64),
   form_no		varchar(15),
   policy_no		varchar(14),
   fee_date		date,
   sign_date		date,
   valid_date 		date,
   holder		varchar(32),
   insured		varchar(32),
   policy_fee		double,
   fee_type 		varchar(12),
   sales_name 		varchar(12),
   bank_name 		varchar(128),
   operate_id bigint,
   primary key (id),
   unique key nsd_p_no (policy_no)
)
engine=innodb auto_increment=1 default charset=utf8;

create table t_renewed_stay
(
   id                   bigint not null auto_increment,
   policy_no            varchar(18),
   cs_date       date,
   operator_id          bigint,
   operate_time         datetime,
   remark varchar(256),
   stay_num integer,
   status varchar(12),
   primary  key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

--管理机构	保单号码	投保人姓名	投保人性别	险种名称		出单网点	借款日期	借款金额	约定还款日期	实际还款日期	还款金额	免息金额	免息原因	保单状态	联系方式
create table t_cs_loan
(
   id   bigint not null auto_increment,
   organ_name varchar(64),
   policy_no	varchar(18),
   holder   varchar(18),
   holder_sexy	varchar(4),
   prod_name	varchar(64),
   bank_name varchar(128),
   loan_date	  date,
   loan_fee	  double,
   should_date	date,
   real_date	  date,
   back_fee	  double,
   free_fee	  double,
   free_reason	  varchar(128),
   status	  varchar(12),
   phone	  varchar(12),
   operate_id	  bigint,
   operate_time	datetime    default   current_timestamp,
   primary  key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

alter table t_renewed_stay modify operate_time datetime default current_timestamp;

alter table t_cs_loan change operator_id operate_id bigint;

alter table t_cs_loan add column remark varchar(256) after phone;
alter table t_cs_loan add column flag int default 0;
update t_cs_loan set flag=case when DATEDIFF(NOW(),should_date)>1 then "2" when  DATEDIFF(NOW(),should_date)>-30 then "1" else "0" end where flag=0;


update t_renewed_list t1, t_cs_report t2 set t1.fee_status="失效" where  t1.policy_no=t2.policy_no and t2.cs_code="RE";

update t_policy t1, t_cs_report t2 set t1.status="终止" where  t1.policy_no=t2.policy_no and t2.cs_code="RE";

update t_renewed_list t1, t_cs_report t2, t_pay_success_list t3 set t1.fee_status="交费成功" where t1.policy_no=t2.policy_no and t2.cs_code="RE" and datediff(now(),t2.operate_time)=0 and t2.cs_no=t3.rel_no and t3.fail_desc="成功";

update t_policy t1, t_cs_report t2, t_pay_success_list t3 set t1.status="有效" where t1.policy_no=t2.policy_no and t2.cs_code="RE" and datediff(now(),t2.operate_time)=0 and t2.cs_no=t3.rel_no and t3.fail_desc="成功";

alter table t_renewed_stay add column cs_money double;

alter table t_policy add column sale_type int(1) DEFAULT '0';
update t_policy set sale_type=1 where policy_no like "76%";
update t_policy set sale_type=2 where policy_no like "96%" or policy_no like "81%";

 alter table t_under_write change sign_input_date bill_back_date date;
 alter table t_under_write add column prod_code varchar(8);
 alter table t_policy change bill_back_date client_receive_date date;
 alter table t_policy add column bill_back_date date after policy_date;
 
 update t_policy t1,t_under_write t2 set t1.bill_back_date=t2.bill_back_date where t1.policy_no=t2.policy_no;
 update t_policy set bill_back_date=client_receive_date where bill_back_date is null;
 
 CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no` and b.attached_flag=0);
  
truncate table t_cs_reissue;
alter table t_cs_reissue drop foreign key fk_reference_28;
alter table t_cs_reissue add CONSTRAINT fk_csr_csr FOREIGN KEY (cs_id) REFERENCES t_cs_report(id);
insert into t_cs_reissue (cs_id,status) select tsr.id,"NewStatus" from t_cs_report tsr where tsr.cs_code="LR" and tsr.id not in (select cs_id from t_cs_reissue);

create table t_cs_expire
(
   id   bigint not null auto_increment,
   policy_no	 varchar(15),
sale_channel	 varchar(6),
duration	 int(3),
policy_end_date	 date,
insured_birthday	 date,
holder_birthday	 date,
holder_card_num	 varchar(19),
holder_card_type	 varchar(15),
holder_year	  int(3),
holder_expire_year	  int(3),
insured_card_num	 varchar(19),
insured_card_type	 varchar(15),
insured_year	  int(3),
insured_expire_year	  int(3),
policy_money	 double,
holder_mobile	 varchar(12),
holder_phone	 varchar(14),
expire_money	 double,
expire_profit	 double,
expire_rate	 float,
year_rate	 float,
relation	 varchar(12),
issue_flag	 varchar(64),
sub_flag	 varchar(12),
bal_match	 varchar(6),
pay_level	 varchar(6),
holder_age_level	 varchar(6),
adult_level	 varchar(6),
age_diff_level	 varchar(6),
issue_level	 varchar(6),
staff_level	 varchar(6),
account_level	 varchar(6),
final_level	 varchar(6),
status varchar(16) default "NewStatus",
operate_id	  bigint,
   operate_time	 datetime    default   current_timestamp,
   primary  key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

ALTER TABLE t_cs_expire ADD INDEX `idx_policy_no` (`policy_no`);
ALTER TABLE t_cs_expire ADD INDEX `idx_policy_end_date` (`policy_end_date`);
ALTER TABLE t_cs_expire ADD INDEX `idx_status` (`status`);

create table t_cs_expire_dtl
(
   id   bigint not null auto_increment,
   cs_expire_id bigint,
   deal_desc varchar(128),
   deal_man varchar(12),
   deal_time datetime,
   operate_id	  bigint,
   operate_time	 datetime    default   current_timestamp,
   primary  key (id)
)engine=innodb auto_increment=4 default charset=utf8;

alter table t_cs_expire_dtl add CONSTRAINT fk_cse_csed FOREIGN KEY (cs_expire_id) REFERENCES t_cs_expire(id);

 alter table t_cs_expire add column cs_date date after status;

alter table t_issue add column checker varchar(16);
alter table t_issue add column check_date datetime;

alter table t_settlement_log add column to_deal_day int(4);
alter table t_settlement_log add column follow_date datetime;
alter table t_settlement_log add column is_follow boolean default false;

alter table t_doc_not_scan_dtl add column operate_time datetime default current_timestamp;


create table t_inquire (
id    bigint  not null auto_increment,
inquire_no    varchar(21),
inquire_type    varchar(12),
inquire_subtype    varchar(18),
inquire_status    varchar(12) DEFAULT 'NewStatus',
inquire_desc    varchar(256),
inquire_remark    varchar(256),
inquire_rst    varchar(1024),
deal_depart    varchar(128),
deal_man    varchar(12),
task_type    varchar(12),
finish_date    varchar(10),
policy_no    varchar(14),
policy_nos    varchar(74),
organ_name    varchar(128),
net_name    varchar(128),
holder    varchar(12),
holder_phone    varchar(12),
holder_mobile    varchar(64),
policy_date    varchar(64),
gpolicy_no    varchar(64),
gorgan_name    varchar(64),
gnet_name    varchar(64),
ginsured    varchar(12),
ginsured_phone    varchar(64),
ginsured_mobile    varchar(64),
gpolicy_date    varchar(64),
client    varchar(12),
client_phone1    varchar(11),
client_phone2    varchar(11),
client_sexy    varchar(3),
client_brd    varchar(10),
client_age    int(3),
client_card_type    varchar(27),
client_card_num    varchar(18),
client_stateless    varchar(12),
client_mz    varchar(12),
client_fm    varchar(6),
client_prov    varchar(15),
client_city    varchar(32),
client_area    varchar(32),
client_dcity    varchar(128),
client_postcode    varchar(6),
  deal_time    date,
  attr_link    varchar(128),
  reopen_reason    varchar(256),
  reopen_id    bigint(20),
  reopen_date    date,
  checker    varchar(16),
  check_date    datetime,
  check_rst    varchar(24),
  to_city_user_id    bigint,
  to_city_date    datetime,
  city_deal_flag boolean default false,
  operate_id    bigint(20),
  operate_time    timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;


alter table t_check_write add column close_date datetime;
alter table t_check_record add column close_date datetime;
alter table t_inquire add column close_user varchar(12) after to_city_user_id;
alter table t_issue add column close_user varchar(12);
alter table t_check_write add column close_user varchar(12);
alter table t_check_record add column close_user varchar(12);

alter table t_settle_task_log add column to_deal_day int(4);
alter table t_settle_task_log add column follow_date datetime;
alter table t_settle_task_log add column is_follow boolean default false;