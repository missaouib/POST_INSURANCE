CREATE DATABASE postinsurance DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;

mysql> grant all privileges on postinsurance.* to yunying@localhost identified by '123456';

mysql> grant all privileges on postinsurance.* to yunying@'%' identified by '123456';


-- 20150506
alter table t_policy add column operate_id bigint;
alter table t_policy add column operate_name date;
alter table t_policy add column operate_time varchar(32);

--20150530
alter table t_bank_code add column bank_name varchar(128);
alter table t_prd add column multiple int;

--20150604
drop table if exists t_policy;

/*==============================================================*/
/* Table: t_policy                                              */
/*==============================================================*/
create table t_policy
(
   id                   bigint not null auto_increment,
   organ_code           varchar(20),
   organ_name           varchar(60),
   policy_no            varchar(12),
   form_no              varchar(25),
   holder               varchar(256),
   insured              varchar(256),
   prod_code            varchar(8),
   prod_name            varchar(128),
   policy_fee           varchar(256),
   insured_amount       varchar(256),
   fee_frequency        varchar(10),
   perm                 int,
   plicy_valid_date     date,
   policy_date          date,
   status               int,
   bank_id              bigint,
   bank_code            varchar(12),
   bank_name            varchar(128),
   sales_name           varchar(256),
   sales_id             varchar(256),
   copies               varchar(256),
   renewal_sucess_flag  int,
   reset_valid_flag     int,
   operate_id           bigint,
   operate_time         date,
   operate_name         varchar(32),
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_policy add column
organ_code           varchar(20),
add column   organ_name           varchar(60),
add column   policy_no            varchar(12),
add column   form_no              varchar(25),
add column   holder               varchar(256),
add column   insured              varchar(256),
add column   prod_code            varchar(8),
add column   prod_name            varchar(128),
add column   policy_fee           varchar(256),
add column   insured_amount       varchar(256),
add column   fee_frequency        varchar(10),
add column   perm                 int,
add column   plicy_valid_date     date,
add column   policy_date          date,
add column   status               int,
add column   bank_id              bigint,
add column   bank_code            varchar(12),
add column   bank_name            varchar(128),
add column   sales_name           varchar(256),
add column   sales_id             varchar(256),
add column   copies               varchar(256),
add column   renewal_sucess_flag  int,
add column   reset_valid_flag     int,
add column   operate_id           bigint,
add column   operate_time         date,
add column   operate_name         varchar(32);

drop table if exists t_policy_dtl;

/*==============================================================*/
/* Table: t_policy_dtl                                          */
/*==============================================================*/
create table t_policy_dtl
(
   id                   bigint not null auto_increment,
   organ_code           varchar(60),
   policy_no            varchar(12),
   holder               varchar(256),
   holder_sexy          int,
   insured              varchar(256),
   prod_name            varchar(128),
   insured_amount       varchar(256),
   policy_fee           varchar(256),
   sales_name           varchar(256),
   policy_date          date,
   holder_phone         varchar(256),
   holder_mobile        varchar(256),
   holder_addr          varchar(512),
   holder_postcode      varchar(6),
   holder_card_type     int,
   holder_card_num      varchar(256),
   operate_id           bigint,
   operate_time         date,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_issue add column
   organ_code           varchar(18),
add column      call_man             varchar(8),
add column      issue_no             varchar(12),
add column      policy_no            varchar(18),
add column      issue_desc           varchar(6),
add column      issue_type           varchar(10),
add column      issue_content        varchar(256),
add column      result       varchar(256),
add column      ready_date           timestamp default current_timestamp,
add column      finish_date          datetime,
add column      bank_code            varchar(20),
add column      bank_name            varchar(256),
add column      should_date          date,
add column      call_date            date,
add column      issue_date           date,
add column      reset_num            int,
add column      recall_flag          varchar(2),
add column      issue_time           date,
add column      status               varchar(10),
add column      deal_man             varchar(32),
add column      deal_time            date,
add column      reopen_reason        varchar(256),
add column      reopen_id            bigint,
add column      reopen_date          date,
add column      operate_id          bigint,
add column      operate_time          timestamp default current_timestamp;


alter table t_policy 
add column   customer_manager_code         varchar(25),
add column   customer_manager              varchar(16);


INSERT INTO t_renewed_list(policy_no, fee_status, fee_fail_reason, prd_name) 
VALUES
('86440100003942', '你好', 'Eliot', '中邮附加重大疾病保险'),
('86440100003942', 'hello', 'Jhon', '中邮年年好B款年金保险（分红型）'), 
('86440100005030', '嘻嘻', 'Jim', '中邮年年好百倍保两全保险') 
ON DUPLICATE KEY UPDATE 
policy_no=VALUES(policy_no), prd_name=VALUES(prd_name), 
fee_status=VALUES(fee_status), fee_fail_reason=VALUES(fee_fail_reason);

alter table t_renewed_list
add column fix_status           varchar(12),
add column    fix_desc             varchar(256),
add column    deal_man             varchar(12),
add column    deal_time            date;

alter table t_call_fail_list add column organ_name varchar(20);
alter table t_issue add column organ_name varchar(20);
alter table t_call_fail_list add column hq_deal_num int;
alter table t_call_fail_list add column prov_deal_num int;
alter table t_issue add column holder_mobile varchar(256);
alter table t_issue add column holder_phone varchar(256);
alter table t_call_fail_list add column holder_phone varchar(256);
alter table t_call_fail_list add column holder_mobile varchar(256);

/* 2015-08-06*/
alter table `t_call_fail_list` add column reset_phone VARCHAR(256);
--------------- SQL ---------------

ALTER TABLE `t_call_fail_list` ADD COLUMN `org_deal_flag` TINYINT(4) DEFAULT 0;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_flag` TINYINT(4) DEFAULT 0;
ALTER TABLE `t_call_fail_list` ADD COLUMN `prov_deal_flag` TINYINT(4) DEFAULT 0;

===============20150810
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_date6` date DEFAULT NULL AFTER `hq_deal_rst5`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_rst6` VARCHAR(120) DEFAULT NULL AFTER `hq_deal_date6`;
--------------- SQL ---------------

ALTER TABLE `t_call_fail_list` ADD COLUMN `has_letter` VARCHAR(32) DEFAULT NULL;

--------------- SQL ---------------

ALTER TABLE `t_call_fail_list` ADD COLUMN `letter_date` DATE DEFAULT NULL;

--------------- SQL ---------------

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no`);

======20150817
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type` varchar(20) DEFAULT NULL AFTER `hq_issue_type`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man` varchar(20) DEFAULT NULL AFTER `hq_deal_type`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type2` varchar(20) DEFAULT NULL AFTER `hq_deal_date2`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man2` varchar(20) DEFAULT NULL AFTER `hq_deal_type2`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type3` varchar(20) DEFAULT NULL AFTER `hq_deal_date3`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man3` varchar(20) DEFAULT NULL AFTER `hq_deal_type3`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type4` varchar(20) DEFAULT NULL AFTER `hq_deal_date4`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man4` varchar(20) DEFAULT NULL AFTER `hq_deal_type4`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type5` varchar(20) DEFAULT NULL AFTER `hq_deal_date5`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man5` varchar(20) DEFAULT NULL AFTER `hq_deal_type5`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_type6` varchar(20) DEFAULT NULL AFTER `hq_deal_date6`;
ALTER TABLE `t_call_fail_list` ADD COLUMN `hq_deal_man6` varchar(20) DEFAULT NULL AFTER `hq_deal_type6`;

alter table t_call_deal_type add column flag int default 0;

====20050825
alter table t_renewed_list add column hq_deal_man varchar(32) AFTER `hq_deal_date`;
alter table t_renewed_list add column prov_deal_man varchar(32);
alter table t_renewed_list add column deal_type varchar(32) AFTER `fix_desc`;
alter table t_renewal_type add column flag int default 0;
ALTER TABLE `t_call_fail_list` ADD COLUMN `prov_deal_man` varchar(20) DEFAULT NULL AFTER `prov_issue_type`;

use picodb;

drop table if exists t_under_write;

/*==============================================================*/
/* Table: t_under_write                                         */
/*==============================================================*/
create table t_under_write
(
   id                   bigint not null auto_increment,
   policy_no            varchar(18),
   form_no              varchar(25),
   organ_id             bigint,
   product_id           bigint,
   holder               varchar(32),
   insured              varchar(32),
   underwrite_reason    varchar(64),
   ybt_date             date,
   sys_date             datetime,
   check_date           datetime,
   issue_flag           tinyint,
   error_desc           varchar(256),
   deal_man             varchar(12),
   underwrite_date      datetime,
   is_letter            boolean,
   sign_date            datetime,
   prov_receive_date    date,
   prov_send_date       date,
   prov_ems_no          varchar(32),
   city_receive_date    date,
   city_send_date       date,
   city_ems_no          varchar(32),
   area_receive_date    date,
   area_send_date       date,
   area_ems_no          varchar(32),
   net_receive_date     date,
   client_receive_date  date,
   sign_input_date      date,
   remark               varchar(250),
   primary key (id),
   unique key ak_key_2 (policy_no)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_under_write add constraint fk_uw_prd foreign key (product_id)
      references t_prd (id);

alter table t_under_write add constraint fk_uw_org foreign key (organ_id)
      references t_organization (id);

alter table t_under_write add column relation varchar(16) after insured;
alter table t_under_write add column policy_fee double after relation;

create table t_pay_fail_list
(
   id                   bigint not null auto_increment,
   account_name         varchar(32),
   account              varchar(256),
   money                varchar(12),
   fail_desc            varchar(32),
   back_date            date,
   fee_type             varchar(16),
   rel_no               varchar(32),
   org_name             varchar(64),
   pay_type             int,
   status               varchar(12),
   operate_id           bigint,
   operate_time         datetime default current_timestamp,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

create table t_check_fix_type
(
   id                   bigint not null auto_increment,
   type_name            varchar(32),
   type_desc            varchar(255),
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_check_write add column fix_type varchar(64) after fix_status;
alter table t_check_record add column fix_type varchar(64) after fix_status;

--------------- SQL ---------------

ALTER TABLE `t_pay_fail_list` MODIFY COLUMN `rel_no` VARCHAR(32) COLLATE utf8_general_ci NOT NULL UNIQUE;

create table t_notice
(
   id                   bigint not null auto_increment,
   sender               bigint,
   send_date            datetime default current_timestamp,
   receiver             bigint,
   receive_org          bigint,
   receive_role         bigint,
   invalid_date         date,
   notice_title         varchar(64),
   notice_content       text,
   primary key (id)
);

create table t_notice_att
(
   id                   bigint not null,
   notice_id            bigint,
   attr_link            varchar(128),
   primary key (id)
);
alter table t_notice_att add constraint fk_notice_attr foreign key (notice_id)
      references t_notice (id) on delete restrict on update restrict;


ALTER TABLE `t_under_write` ADD COLUMN `has_record` TINYINT(1) DEFAULT 1 AFTER `error_desc`;

ALTER TABLE `t_under_write` ADD COLUMN `record_desc` VARCHAR(254) DEFAULT 1 AFTER `has_record`;

ALTER TABLE `t_under_write` ADD COLUMN `status` VARCHAR(16) DEFAULT 1 AFTER `deal_man`;


create table t_offsite_conservation
(
   id                   bigint not null auto_increment,
   org_code             varchar(16),
   transactor           varchar(16),
   deal_date            date,
   policy_no            varchar(18),
   orgin_prov           varchar(12),
   client               varchar(12),
   conservation_type    varchar(12),
   linker               varchar(12),
   prov_deal_date       date,
   express_bill_no      varchar(16),
   mail_addr            varchar(128),
   remark               varchar(256),
   operator_id          bigint,
   operate_time         datetime,
   primary key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

create table t_prov_org_code
(
   id                   bigint not null auto_increment,
   org_code             varchar(8),
   org_name             varchar(12),
   primary key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

create table t_conservation_type
(
   id                   bigint not null auto_increment,
   cs_type              varchar(4),
   cs_name              varchar(16),
   primary key (id)
)
engine=innodb auto_increment=4 default charset=utf8;

ALTER TABLE `t_conservation_dtl` MODIFY COLUMN `type` VARCHAR(8) DEFAULT NULL;

update t_conservation_dtl set type=info;
update t_conservation_dtl set info=cs_rst;
update t_conservation_dtl set cs_rst=null;

ALTER TABLE `t_call_fail_list` ADD COLUMN `addr` VARCHAR(256) DEFAULT NULL AFTER `result`;
ALTER TABLE `t_issue` ADD COLUMN `addr` VARCHAR(256) DEFAULT NULL AFTER `issue_content`;

ALTER TABLE `t_call_fail_list` ADD COLUMN `id_card` VARCHAR(256) DEFAULT NULL AFTER `result`;
ALTER TABLE `t_issue` ADD COLUMN `id_card` VARCHAR(256) DEFAULT NULL AFTER `issue_content`;

--------------- SQL ---------------

ALTER TABLE `t_offsite_conservation` ADD COLUMN `status` VARCHAR(12) DEFAULT NULL AFTER `remark`;

--------------- SQL ---------------

ALTER TABLE `t_conservation_dtl` CHANGE COLUMN `type` `conservation_code` VARCHAR(8) COLLATE utf8_general_ci DEFAULT NULL;
--------------- SQL ---------------

ALTER TABLE `t_notice_att` MODIFY COLUMN `id` BIGINT(20) NOT NULL AUTO_INCREMENT;


alter table t_conservation_dtl  add column cs_sys_date date;
alter table t_conservation_dtl  add column cs_fee double;

create table t_cs_reissue
(
   id                   bigint not null,
   cs_id                bigint,
   prov_express_no      varchar(32),
   prov_receive_date    date,
   prov_sent_date       date,
   status               varchar(12),
   city_receive_date    date,
   city_receiver        varchar(16),
   remark               varchar(255),
   primary key (id)
);

alter table t_cs_reissue add constraint fk_reference_28 foreign key (cs_id)
      references t_conservation_dtl (id) on delete restrict on update restrict;


create table t_pay_success_list
(
   id                   bigint not null auto_increment,
   account_name         varchar(32),
   account              varchar(256),
   money                varchar(12),
   fail_desc            varchar(32),
   back_date            date,
   fee_type             varchar(16),
   rel_no               varchar(32),
   org_name             varchar(64),
   pay_type             int,
   status               int,
   operate_id           bigint,
   operate_time         datetime default current_timestamp,
   primary key (id)
)
engine=innodb auto_increment=1 default charset=utf8;

alter table t_call_fail_list  add column can_call_again boolean;
alter table t_call_fail_list  add column can_call_again_remark varchar(127);

--------------- SQL ---------------

ALTER TABLE `t_under_write` ADD COLUMN `holder_age` TINYINT(4) DEFAULT NULL AFTER `holder`;
ALTER TABLE `t_log_info` MODIFY COLUMN `message` VARCHAR(1024) COLLATE utf8_general_ci DEFAULT NULL;

ALTER TABLE `t_offsite_conservation` ADD COLUMN `deal_prov` VARCHAR(32) DEFAULT NULL;

--------------- SQL ---------------

ALTER TABLE `t_notice_att` MODIFY COLUMN `id` BIGINT(20) NOT NULL AUTO_INCREMENT;

ALTER TABLE `t_call_fail_list` ADD COLUMN `reset_date` DATE DEFAULT NULL;

--------------- SQL ---------------

ALTER TABLE `t_policy` ADD COLUMN `bill_back_date` DATE DEFAULT NULL AFTER `policy_date`;

ALTER TABLE `t_offsite_conservation` ADD COLUMN `deal_prov` VARCHAR(32) DEFAULT NULL;

-- alter table t_call_fail_list add column door_back_rst varchar(128) default null;

-- alter table t_call_fail_list add column door_date date default null;

-- alter table t_call_fail_list add column door_man varchar(32) default null;

alter table t_call_fail_list add column door_back_date date default null;

alter table t_call_fail_list add column door_stats_date date default null;

alter table t_call_fail_list add column mail_fail_reason varchar(128) default null;

alter table t_call_fail_list add column mail_fail_date date default null;

alter table t_call_fail_list add column mail_success varchar(32) default null;

alter table t_call_fail_list add column mail_back_date date default null;

alter table t_call_fail_list add column client_sign_date date default null;

ALTER TABLE `t_log_info` ADD COLUMN `module` VARCHAR(32) DEFAULT NULL;

ALTER TABLE `t_call_fail_list` MODIFY COLUMN `finish_date` TIMESTAMP NULL;

--------------- SQL ---------------

ALTER TABLE `t_renewed_list` MODIFY COLUMN `policy_no` VARCHAR(18) COLLATE utf8_general_ci NOT NULL UNIQUE;

update t_call_fail_list t1, t_call_fail_list t2
set t1.status=t2.status
where t1.policy_no=t2.policy_no
and t2.status="二访成功"

alter table t_call_fail_list add column client_remark varchar(254) default null;
alter table t_call_fail_list add column hq_deal_type_else varchar(254) default null;

DELETE FROM `t_call_fail_list`
USING `t_call_fail_list`,(
  SELECT DISTINCT max(`id`) AS `id`,`policy_no`
  FROM `t_call_fail_list`
  GROUP BY `policy_no`
  HAVING COUNT(1) > 1
) AS `t2`
WHERE `t_call_fail_list`.`policy_no` = `t2`.`policy_no`
  AND `t_call_fail_list`.`id` <> `t2`.`id`;
  
alter table t_call_fail_list add column phone_num varchar(23) default null;
alter table t_call_fail_list add column phone_start varchar(23) default null;
alter table t_call_fail_list add column phone_end varchar(23) default null;
alter table t_call_fail_list add column phone_time varchar(23) default null;

CREATE OR REPLACE  ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `v_call_fail_list`
AS
select
  `a`.*,
  (`b`.`policy_date` + interval 12 day) AS `check_date`,
  (`b`.`policy_date` + interval 15 day) AS `end_date`,
  (to_days((`b`.`policy_date` + interval 15 day)) - to_days(now())) AS `last_date_num`
from
  (`t_call_fail_list` `a`
  join `t_policy` `b`)
where
  (`a`.`policy_no` = `b`.`policy_no`);

ALTER TABLE `t_policy` ADD INDEX `idx_policy_formno` (`form_no`);

update t_policy set policy_fee=cast(aes_decrypt(unhex(policy_fee), 'GDPost') as char(100))

update t_policy set holder=cast(aes_decrypt(unhex(holder), 'GDPost') as char(100))

ALTER TABLE `t_policy` MODIFY COLUMN `policy_fee` DOUBLE(15,2) DEFAULT NULL;

ALTER TABLE `t_prd` ADD COLUMN `prd_full_name` VARCHAR(36) DEFAULT NULL AFTER `prd_name`;
