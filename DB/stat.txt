select organ_id,
count(form_no) as un_count,
sum(IFNULL(datediff(sign_input_date,ybt_date),datediff(now(),ybt_date))) as length_time 'å…¨æ—¶æ•?
from t_under_write 
where ybt_date>='2017-01-01' or sign_date>='2017-01-01'
group by organ_id

select
        
    left(tp.organ_name,
    2) as organ_name,
    sum(tp.total_fee) as sum_policy_fee,
    t2.policy_fee as policy_fee,
    t3.sum_cs_fee as sum_cs_fee from
        t_policy tp 
    left JOIN
        (
            select
                
            left(itp.organ_name,
            2) as organ_name,
            sum(itp.total_fee) as policy_fee from
                t_policy itp,
                t_cs_report itcr 
            where
                itp.organ_code<>"86440001" 
                and itp.attached_flag=0 
                and itp.policy_no=itcr.policy_no 
                and itcr.cs_code="CT" 
                and itp.cs_flag<>1 
                and itp.policy_date between ? and ? 
                and itcr.cs_date between ? and ?  
                and itp.prod_name like ?  
                and itp.fee_frequency like ? 
                and itp.staff_flag like ? 
            group by
                
            left(itp.organ_name,
            2) 
    ) t2 
        on t2.organ_name=left(tp.organ_name,
    2) left join
        (
            select
                
            left(itp.organ_name,
            2) as organ_name,
            sum(itcr.money) as sum_cs_fee from
                t_policy itp,
                t_cs_report itcr 
            where
                itp.organ_code<>"86440001" 
                and itp.policy_no=itcr.policy_no 
                and itcr.cs_code="CT" 
                and itp.cs_flag<>1 
                and itp.attached_flag=0 
                and itp.policy_date between ? and ? 
                and itcr.cs_date between ? and ? 
                and itp.prod_name like ? 
                and itp.fee_frequency like ? 
                and itp.staff_flag like ? 
            group by
                
            left(itp.organ_name,
            2) 
    ) t3 
        on t3.organ_name=left(tp.organ_name,
    2) where
        tp.organ_code<>"86440001" 
        and tp.attached_flag=0 
        and tp.cs_flag<>1 
        and tp.policy_date between ? and ? 
        and tp.organ_code like ? 
        and tp.prod_name like ? 
        and tp.fee_frequency like ? 
        and tp.staff_flag like ? 
    group by
        
    left(tp.organ_name,
    2) order by
        tp.organ_code;
        
        
select left(hb.name,2) as org_name,SUM(hb.L50) as 'l50',SUM(hb.L30) as 'l30',SUM(hb.L20) as 'l20', SUM(hb.L10) as 'l10',(SUM(hb.L50)+SUM(hb.L30)+SUM(hb.L20)+ SUM(hb.L10)) as 'sc' from 
(select tb.org_code, tb.name, 
count(case when longPerm='L50' then 'L50' else null end) as 'L50', 
count(case when longPerm='L30' then 'L30' else NULL end) as 'L30', 
count(case when longPerm='L20' then 'L20' else NULL end) as 'L20', 
count(case when longPerm='L10' then 'L10' else NULL end) as 'L10' 
from ( 
select org.org_code, org.name, 
case when DATEDIFF(now(),prov_send_date)>=50 then 'L50' 
when DATEDIFF(now(),prov_send_date)>=30 then 'L30' 
when DATEDIFF(now(),prov_send_date)>=20 then 'L20' 
else 'L10' 
end as longPerm 
from t_under_write uw, t_organization org 
where uw.organ_id=org.id and prov_send_date is not null 
and client_receive_date is null 
and uw.sign_date between '2017-01-01' and '2017-12-31' 
and org.org_code like '8644%' 
) as tb 
GROUP BY tb.org_code, tb.name 
) as hb 
group by left(hb.name,2) 
order by hb.org_code 
;

update t_under_write uw inner join (select it2.name as net_name, policy_no from t_policy it1,t_bank_code it2 where it1.bank_code=it2.cpi_code) as tp2 set uw.net_name=uw.net_name where uw.net_name is null and uw.policy_no is not null and uw.policy_no=tp2.policy_no;

update t_under_write uw,t_policy tp,t_bank_code bc set uw.net_name=bc.name where uw.policy_no is not null and uw.net_name is not null and uw.policy_no=tp.policy_no and tp.bank_code=bc.cpi_code;

select uw.policy_no, uw.form_no, uw.holder, uw.prd_name, uw.net_name, 
uw.ybt_date, uw.sign_date, uw.prov_send_date, uw.prov_ems_no, org.org_code, org.name,
case when DATEDIFF(now(),prov_send_date)>=50 then 'L50' 
when DATEDIFF(now(),prov_send_date)>=30 then 'L30' 
when DATEDIFF(now(),prov_send_date)>=20 then 'L20' 
else 'L10' 
end as long_perm 
from t_under_write uw, t_organization org 
where uw.organ_id=org.id and prov_send_date is not null 
and client_receive_date is null 
and uw.sign_date between '2017-01-01' and '2017-12-31' 
and org.org_code like '8644%' 
order by org.org_code;